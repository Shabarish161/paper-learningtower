# Generated by `rjournal_article()` using `knitr::purl()`: do not edit by hand
# Please edit learningtower.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      error = FALSE)


## ----loadlibraries------------------------------------------------------------
library(rjtools)
library(learningtower)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(patchwork)
library(viridis)
library(plotly)
library(ggplot2)
library(ggbeeswarm)
library(gganimate)


## ----gendergap, fig.height = 14, fig.width = 6, fig.align = "center", fig.pos="H"----

student_2018 <- load_student("2018")
data(countrycode, package = "learningtower")

student_country <- left_join(student_2018, countrycode, by = "country")


#removing na values
math_pisa_2018_data <- student_country %>% 
  filter(!is.na(gender), !is.na(math), !is.na(stu_wgt))


#avg math scores and diff 
math_diff_df <- math_pisa_2018_data %>%
  group_by(gender, country_name) %>% 
  summarise(avg = weighted.mean(math, stu_wgt)) %>%
  ungroup() %>%
  pivot_wider(country_name, 
              names_from = gender,
              values_from = avg) %>%
mutate(diff = female - male, 
       country_name = fct_reorder(country_name, diff))


#Bootstrap
set.seed(2020)
boot_ests_math <- map_dfr(1:100, ~{
  math_pisa_2018_data %>%
  group_by(country_name, gender) %>%
  sample_n(size = n(), replace = TRUE) %>%
  summarise(avg = weighted.mean(math, stu_wgt), .groups = "drop") %>%
  ungroup() %>%
  pivot_wider(country_name, names_from = gender, values_from = avg) %>%
  mutate(diff = female - male, country_name = fct_reorder(country_name, diff)) %>%
  mutate(boot_id = .x) 
})

#Confidence Intervals
math_diff_conf_intervals <- boot_ests_math %>%
  group_by(country_name) %>%
  summarise(lower = sort(diff)[5],
  upper = sort(diff)[95])%>%
  left_join(math_diff_df, by = "country_name") %>%
  mutate(country_name = fct_reorder(country_name, diff)) %>%
  mutate(score_class = case_when(lower < 0 & upper < 0 ~ "red", 
                           lower < 0 & upper > 0 ~ "blue",
                           lower > 0 & upper > 0 ~ "green"))

#Math Plot
math_plot <- ggplot(math_diff_conf_intervals, 
                    aes(diff, country_name, 
                        col = score_class)) +
  scale_colour_brewer(palette = "Dark2") +
  geom_point() + geom_errorbar(aes(xmin = lower, xmax = upper)) +
  geom_vline(xintercept = 0, color = "red") +
  labs(y = "",
  x = "Maths Scores Girls - Boys", 
  title = "Maths") +
  theme(legend.position="none") + 
  annotate("text", x = 10.5, y = 1, label = "Girls") +
  annotate("text", x = -10.5, y = 1, label = "Boys") +
  scale_x_continuous(breaks = pretty(math_diff_conf_intervals$diff), 
                     labels = abs(pretty(math_diff_conf_intervals$diff)))


## -----------------------------------------------------------------------------
#removing na values
read_pisa_2018_data <- student_country %>%  
  filter(!is.na(gender)) %>% 
  filter(!is.na(read)) %>% 
  filter(!is.na(stu_wgt)) 

#avg math scores and diff 
read_diff_df <- read_pisa_2018_data %>%
  group_by(gender, country_name) %>%
  summarise(avg = weighted.mean(read, stu_wgt), .groups = "drop") %>%
  ungroup() %>%
  pivot_wider(country_name, names_from = gender,
  values_from = avg) %>%
  mutate(diff = female - male,
  country_name = fct_reorder(country_name, diff))

#Bootstrap
boot_ests_read <- map_dfr(1:100, ~{
  read_pisa_2018_data %>%
  group_by(country_name, gender) %>%
  sample_n(size = n(), replace = TRUE) %>%
  summarise(avg = weighted.mean(read, stu_wgt)) %>%
  ungroup() %>%
  pivot_wider(country_name, names_from = gender, values_from = avg) %>%
  mutate(diff = female - male, country_name = fct_reorder(country_name, diff)) %>%
  mutate(boot_id = .x)
})

#CI
read_diff_conf_intervals <- boot_ests_read %>%
  group_by(country_name) %>%
  summarise(lower = sort(diff)[5],
  upper = sort(diff)[95])%>%
  left_join(read_diff_df, by = "country_name") %>%
  mutate(country_name = fct_reorder(country_name, diff)) %>%
  mutate(score_class = case_when(lower < 0 & upper < 0 ~ "red", 
                           lower < 0 & upper > 0 ~ "blue",
                           lower > 0 & upper > 0 ~ "green"))


read_plot <- ggplot(read_diff_conf_intervals, 
                    aes(diff, country_name, 
                        col = score_class)) + 
  scale_colour_brewer(palette = "Dark2") +
  geom_point() + geom_errorbar(aes(xmin = lower, xmax = upper)) +
  geom_vline(xintercept = 0, color = "red") +
  labs(y = "",
  x = "Reading Scores Girls - Boys", 
  title = "Reading") +
  theme(legend.position="none") +
  annotate("text", x = 20, y = 1, label = "Girls") +
  scale_x_continuous(breaks = pretty(math_diff_conf_intervals$diff), 
                     labels = abs(pretty(math_diff_conf_intervals$diff)))


## -----------------------------------------------------------------------------
#removing na values
sci_pisa_2018_data <- student_country %>% 
  filter(!is.na(gender)) %>% 
  filter(!is.na(science)) %>% 
  filter(!is.na(stu_wgt)) 

#avg math scores and diff 
sci_diff_df <- sci_pisa_2018_data %>%
  group_by(gender, country_name) %>%
  summarise(avg = weighted.mean(science, stu_wgt), .groups = "drop") %>%
  ungroup() %>%
  pivot_wider(country_name, names_from = gender,
  values_from = avg) %>%
  mutate(diff = female - male,
  country_name = fct_reorder(country_name, diff))


#Bootstrap
boot_ests_sci <- map_dfr(1:100, ~{
  sci_pisa_2018_data %>%
  group_by(country_name, gender) %>%
  sample_n(size = n(), replace = TRUE) %>%
  summarise(avg = weighted.mean(science, stu_wgt)) %>%
  ungroup() %>%
  pivot_wider(country_name, names_from = gender, values_from = avg) %>%
  mutate(diff = female - male, country_name = fct_reorder(country_name, diff)) %>%
  mutate(boot_id = .x)
})

#Bootstrap using R: Part 3
sci_diff_conf_intervals <- boot_ests_sci %>%
  group_by(country_name) %>%
  summarise(lower = sort(diff)[5],
  upper = sort(diff)[95])%>%
  left_join(sci_diff_df, by = "country_name") %>%
  mutate(country_name = fct_reorder(country_name, diff)) %>%
  mutate(score_class = case_when(lower < 0 & upper < 0 ~ "red", 
                           lower < 0 & upper > 0 ~ "blue",
                           lower > 0 & upper > 0 ~ "green"))


sci_plot <- ggplot(sci_diff_conf_intervals, 
                    aes(diff, country_name, 
                        col = score_class)) +
  scale_colour_brewer(palette = "Dark2") +
  geom_point() + geom_errorbar(aes(xmin = lower, xmax = upper)) +
  geom_vline(xintercept = 0, color = "red") +
  labs(y = "",
  x = "Science Scores Girls - Boys", 
  title = "Science") +
  theme(legend.position="none") + 
  annotate("text", x = 10, y = 1, label = "Girls") +
  annotate("text", x = -5, y = 1, label = "Boys") +
  scale_x_continuous(breaks = pretty(math_diff_conf_intervals$diff), 
                     labels = abs(pretty(math_diff_conf_intervals$diff)))


## ----score-differences, fig.cap ="The chart above depicts the gender gap difference in 15-year-olds' in math, reading, and science results in 2018. The scores to the right of the red line represent the performances of the girls, while the scores to the left of the red line represent the performances of the boys. One of the most intriguing conclusions we can get from this chart is that in the PISA experiment in 2018, girls from all nations outperformed boys in reading.", fig.width=12, fig.height=16, fig.pos = "H", out.width="100%", layout="l-body"----
math_plot + read_plot + sci_plot


## -----------------------------------------------------------------------------
theme_map <- function(...) {
  theme_minimal() +
  theme(
    text = element_text(),
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank()
  )
}


## -----------------------------------------------------------------------------
math_map_data <- math_diff_conf_intervals  %>% 
  dplyr::mutate(country_name = case_when(
                country_name == "Brunei Darussalam" ~ "Brunei",
                country_name == "United Kingdom" ~ "UK",
                country_name %in% c("Macau SAR China", "B-S-J-Z (China)", 
                                    "Hong Kong SAR China") ~ "China",
                country_name == "Korea" ~ "South Korea",
                country_name == "North Macedonia" ~ "Macedonia",
                country_name == "Baku (Azerbaijan)" ~ "Baku",
                country_name %in% c("Moscow Region (RUS)", "Tatarstan (RUS)",
                "Russian Federation") ~ "Russia",
                country_name == "Slovak Republic" ~ "Slovakia",
                country_name == "Chinese Taipei" ~ "Taiwan",
                country_name == "United States" ~ "USA",
                TRUE ~ as.character(country_name)))

world_map <- map_data("world") %>% 
  filter(region != "Antarctica") %>% 
  fortify() %>% 
  rename(country_name = region)

math_world_data <- full_join(math_map_data,
                        world_map,
                        by = "country_name") 

math_world_data <- math_world_data %>% 
  rename(Country = country_name, 
         Maths = diff) %>% 
  mutate(Maths = round(Maths, digits = 2))


math_map_plot <- ggplot(math_world_data, 
                        aes(x = long, y = lat, group = group)) +
                  geom_polygon(aes(fill= Maths,  
                                   label = Country)) +
                  theme_map() +
                  labs(title = "World Map displaying Maths Scores Difference") +
                  scale_fill_viridis(option = "D")


## -----------------------------------------------------------------------------
# Maps in R - Reading Maps
read_map_data <- read_diff_conf_intervals %>% 
  dplyr::mutate(country_name = case_when(
                country_name == "Brunei Darussalam" ~ "Brunei",
                country_name == "United Kingdom" ~ "UK",
                country_name %in% c("Macau SAR China", "B-S-J-Z (China)", 
                                    "Hong Kong SAR China") ~ "China",
                country_name == "Korea" ~ "South Korea",
                country_name == "North Macedonia" ~ "Macedonia",
                country_name == "Baku (Azerbaijan)" ~ "Baku",
                country_name %in% c("Moscow Region (RUS)", "Tatarstan (RUS)",
                "Russian Federation") ~ "Russia",
                country_name == "Slovak Republic" ~ "Slovakia",
                country_name == "Chinese Taipei" ~ "Taiwan",
                country_name == "United States" ~ "USA",
                TRUE ~ as.character(country_name)))

world_map <- map_data("world") %>% 
  filter(region != "Antarctica") %>% 
  fortify() %>% 
  rename(country_name = region)

read_world_data <- full_join(read_map_data,
                        world_map,
                        by = "country_name") 

read_world_data <- read_world_data %>% 
  rename(Country = country_name, 
         Reading = diff) %>% 
  mutate(Reading = round(Reading, digits = 2))



read_map_plot <- ggplot(read_world_data, 
                        aes(x = long, y = lat, group = group)) +
                  geom_polygon(aes(fill= Reading, 
                                   label = Country)) +
                  theme_map() +
                  labs(title = "World Map displaying Reading Scores Difference") +
                  scale_fill_viridis(option = "C")


## -----------------------------------------------------------------------------
sci_map_data <- sci_diff_conf_intervals %>% 
  dplyr::mutate(country_name = case_when(
                country_name == "Brunei Darussalam" ~ "Brunei",
                country_name == "United Kingdom" ~ "UK",
                country_name %in% c("Macau SAR China", "B-S-J-Z (China)", 
                                    "Hong Kong SAR China") ~ "China",
                country_name == "Korea" ~ "South Korea",
                country_name == "North Macedonia" ~ "Macedonia",
                country_name == "Baku (Azerbaijan)" ~ "Baku",
                country_name %in% c("Moscow Region (RUS)", "Tatarstan (RUS)",
                "Russian Federation") ~ "Russia",
                country_name == "Slovak Republic" ~ "Slovakia",
                country_name == "Chinese Taipei" ~ "Taiwan",
                country_name == "United States" ~ "USA",
                TRUE ~ as.character(country_name)))

world_map <- map_data("world") %>% 
  filter(region != "Antarctica") %>% 
  fortify() %>% 
  rename(country_name = region)

sci_world_data <- full_join(sci_map_data,
                        world_map,
                        by = "country_name") 

sci_world_data <- sci_world_data %>% 
  rename(Country = country_name, 
         Science = diff)  %>% 
  mutate(Science = round(Science, digits = 2))

sci_map_plot <- ggplot(sci_world_data, 
                        aes(x = long, y = lat, group = group)) +
                  geom_polygon(aes(fill= Science, 
                                   label = Country)) +
                  theme_map() +
                  labs(title = "World Map displaying Science Scores Difference") +
                  scale_fill_viridis(option = "G")


## ----plotly-maps, fig.cap="Interactive maps that show the gender gap in math, reading, and science results between girls and boys throughout the world. The interactive aspect of the map allows one to move their cursor around the global map, which displays the country name as well as the gender gap scores between girls and boys. A positive score for a country indicates that girls outperformed boys in that country, whereas a negative score for a country difference indicates that boys outperformed girls in that country. The diverging colour scale makes it possible to interpret the range of scores and the also helps us intrepret the gender gap difference among these students across the globe. The reading scores all have positive values, indicating that girls outperform boys across the world in the year 2018.", fig.pos="H", fig.height=4, fig.width=12, out.width="100%", layout="l-body", include=knitr::is_html_output(), eval=knitr::is_html_output()----
#> gmp1 <- ggplotly(math_map_plot)
#> gmp2 <- ggplotly(read_map_plot)
#> gmp3 <- ggplotly(sci_map_plot)
#> # fig <- subplot(gmp1, gmp2, gmp3, nrows = 3)
#> # s1 <- subplot(gmp1, gmp2, nrows =2)
#> gmp1
#> gmp2
#> gmp3


## ----ggplot-maps, fig.cap="Maps that show the gender gap in math, reading, and science results between girls and boys throughout the world. The diverging colour scale makes it possible to interpret the range of scores and the also helps us intrepret the gender gap difference among these students across the globe. The legend for each discipline enables interpretation of the score differential for each subject across all maps. A positive score for a country indicates that girls outperformed boys in that country, whereas a negative score for a country difference indicates that boys outperformed girls in that country.The reading scores are all positive, suggesting that girls outperform boys globally in the year 2018.", fig.height=9, fig.pos="H", out.width="100%", layout="l-body", include=knitr::is_latex_output(), eval=knitr::is_latex_output()----
math_map_plot/read_map_plot/sci_map_plot


## -----------------------------------------------------------------------------
p1 <- ggplot(data = student_country, 
             aes(x = math, y = read)) +
  geom_hex() + 
  labs(x = "Math Scores", 
       y = "Reading Scores") +
  theme(legend.position="none")

p2 <- ggplot(data = student_country, 
             aes(x = math, y = science)) +
  geom_hex() + 
  labs(x = "Math Scores", 
       y = "Science Scores") +
  theme(legend.position = "bottom", 
        legend.box = "horizontal", 
        legend.text=element_text(size=7.2))

p3 <- ggplot(data = student_country, 
             aes(x = read, y = science)) +
  geom_hex() + 
  labs(x = "Reading Scores", 
       y = "Science Scores") +
  theme(legend.position="none")


## ----corr-plot, fig.cap ="The scatterplot displays the relationship between math, reading, and science scores for all PISA countries that participated in the experiment in 2018. This scatterplot shows that all three subjects have a significant and positive correlation with one another.", fig.width=9, fig.pos = "H", out.width="100%", layout="l-body"----
p1+p2+p3


## -----------------------------------------------------------------------------
student_country_data <- left_join(student_2018,
                                  countrycode,
                                  by = "country")


father_qual_math_read_sci_data <- student_country_data %>%
  group_by(country_name, father_educ) %>%
  dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
                   read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
                   sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>%
dplyr::mutate(father_educ = recode_factor(father_educ,
                "less than ISCED1" = "Early Childhood",
                "ISCED 1" = "Primary",
                "ISCED 2" = "Lower Secondary",
                "ISCED 3A" = "Upper Secondary",
                "ISCED 3B, C" = "Upper Secondary",
                .ordered = TRUE)) %>%
  na.omit() %>%
  rename(`Father's Education` = father_educ)




mother_qual_math_read_sci_data <- student_country_data %>%
  group_by(country_name, mother_educ) %>%
  dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
                   read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
                   sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>% 
dplyr::mutate(mother_educ = recode_factor(mother_educ,
                "less than ISCED1" = "Early Childhood",
                "ISCED 1" = "Primary",
                "ISCED 2" = "Lower Secondary",
                "ISCED 3A" = "Upper Secondary",
                "ISCED 3B, C" = "Upper Secondary",
                .ordered = TRUE)) %>%
  na.omit() %>%
  rename(`Mother's Education` = mother_educ)


mother_qual_math <- ggplot(mother_qual_math_read_sci_data, 
       aes(x=`Mother's Education`,
           y=math_avg,
           col=`Mother's Education`)) +
  geom_quasirandom(size = 1.7, 
             cex = 3) +
  geom_line(aes(group = country_name), 
            size=0.5, alpha=.36) +
  scale_fill_viridis(discrete = TRUE,
                     option = "A",
                      alpha=0.2) +
    stat_summary(fun.y = median, 
                 fun.ymin = median, 
                 fun.ymax = median,
                 geom = "crossbar", 
                 width = 0.5, 
                 col = "black") +
  theme(legend.position="none",
      plot.title = element_text(size=11)) +
    labs(y = "Average Mathematics Score",
         x = "Mother's Qualification",
         title = "Maths Scores and Mother's Qualification")

father_qual_math <- ggplot(father_qual_math_read_sci_data, 
       aes(x=`Father's Education`,
           y=math_avg,
           col=`Father's Education`)) +
  geom_quasirandom(size = 1.7, 
             cex = 3) +
  geom_line(aes(group = country_name), 
            size=0.5, alpha=.36) +
  scale_fill_viridis(discrete = TRUE,
                     option = "A",
                      alpha=0.2) +
    stat_summary(fun.y = median, 
                 fun.ymin = median, 
                 fun.ymax = median,
                 geom = "crossbar", 
                 width = 0.5, 
                 col = "black") +
  theme(legend.position="none",
      plot.title = element_text(size=11)) +
    labs(y = "Average Mathematics Score",
         x = "Father's Qualification",
         title = "Maths Scores and Father's Qualification")


## ----qual-plot, fig.cap ="The influence of parents' education on their children's academic success. When the parents have attained higher levels of education, the figure shows a significant increase in scores and an increase in the median of scores for each category. When compared to the parents who have lesser levels of education qualifications. Parents upper secondary education or equivalent qualifications children tend to scoree higer in weighted average math scores.", fig.width= 16, fig.height= 8, fig.pos = "H", out.width="100%", layout="l-body"----
father_qual_math + mother_qual_math


## -----------------------------------------------------------------------------
z_star_95 <- qnorm(0.975) 

tv_math_data <- student_country_data %>% 
  group_by(country_name, television) %>% 
  dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE), 
                   lower = weighted.mean(math, w = stu_wgt, na.rm = TRUE) - z_star_95 * (sd(math, na.rm = TRUE)) / sqrt(length(math)), 
                   upper = weighted.mean(math, w = stu_wgt, na.rm = TRUE) + z_star_95 * (sd(math, na.rm = TRUE)) / sqrt(length(math))) %>% 
  dplyr::mutate(television = recode_factor(television,
                 "0" = "No TV",
                 "1" = "1 TVs",
                 "2" = "2 Tvs",
                 "3+" = "3+ TVs", 
                .ordered = TRUE)) %>%
  na.omit() %>% 
  dplyr::select(television, 
                math_avg, 
                lower, 
                upper)



linear_model <- function(y, x){
  coef(lm(y ~ x))[2]
}

tv_plot <- tv_math_data %>%
  group_by(country_name) %>%
  mutate(slope = linear_model(math_avg, television)) %>%
  ungroup() %>%
  mutate(country_name = fct_reorder(country_name, slope)) %>%
  ggplot(aes(x=television, y=math_avg)) + 
  geom_point(size=1.8) +
  geom_line(aes(group = country_name)) +
  geom_errorbar(aes(ymin = lower, ymax = upper, group = country_name),
                width=0.18, colour="orange", alpha=0.3, size=1.53) +
  facet_wrap(~country_name, ncol = 5, scales = "free") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  labs(x = "Possession of Television",
       y = "Average Mathematics Score")


## ----tv-plot, fig.cap ="The impact of television on student performance is a contentious issue, however in this graph, we have examined the effects of television on student performance using statistical methods. The counties are arranged according to the slope of the linear model fitted for the math average score against the various levels of television. We can observe that television has the greatest influence on performance in a select countries, such as Lebanon, whilst it has the least impact in Slovenia. The confidence interval suggests that there is an uncertainty of the scores when a household does not own a television in the majority of the nations that participated in the PISA experiment in the year 2018", fig.height=21, fig.width=12, fig.pos = "H", out.width="100%", layout="l-body"----
tv_plot


## -----------------------------------------------------------------------------
z_star_95 <- qnorm(0.975) 

book_math_read_sci_data <- student_country_data %>% 
  group_by(country_name, book)  %>% 
  dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE), 
                   bk_lower = weighted.mean(math, w = stu_wgt, na.rm = TRUE) - z_star_95 * (sd(math, na.rm = TRUE)) / sqrt(length(math)), 
                   bk_upper = weighted.mean(math, w = stu_wgt, na.rm = TRUE) + z_star_95 * (sd(math, na.rm = TRUE)) / sqrt(length(math)))  %>% 
  dplyr::mutate(book = recode_factor(book, 
                                     "0-10" = "0-10",
                                     "11-25" = "11-25", 
                                     "26-100" = "26-100",
                                     "101-200" = "101-200",
                                     "201-500" = "201-500",
                                     "more than 500" = "500+",
                                     .ordered = TRUE)) %>% 
  na.omit() %>% 
  rename(Number_of_Books = book)

linear_model <- function(y, x){
  coef(lm(y ~ x))[2]
}


book_plot <- book_math_read_sci_data %>%
  group_by(country_name) %>%
  mutate(slope = linear_model(math_avg, Number_of_Books)) %>%
  ungroup() %>%
  mutate(country_name = fct_reorder(country_name, slope)) %>%
  ggplot(aes(x=Number_of_Books, y=math_avg)) + 
  geom_point(size=1.8) +
  geom_line(aes(group = country_name)) +
  geom_errorbar(aes(ymin = bk_lower, ymax = bk_upper, group = country_name),
                width=0.18, colour="darkred", alpha=0.3, size=1.53) +
  facet_wrap(~country_name, ncol = 5, scales = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Possession of Books",
       y = "Average Mathematics Score")


## ----book-plot, fig.cap ="Books are man's best friend. In this graph, we're looking at the influence that the number of books each family has. This graph shows that the more the quantity of books that a households owns, the greater the effect is observed in the student average math scores. We find that countries such as the Dominican Republic and Panama have a lower influence of books when compared to Luxembourg and Hungary.", fig.height=21, fig.width=12, fig.pos = "H", out.width="100%", layout="l-body"----
book_plot


## -----------------------------------------------------------------------------
int_math_read_sci_data <- student_country_data %>% 
  group_by(country_name, internet) %>% 
  dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE), 
                   read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE), 
                   sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>% 
  na.omit() 

comp_math_read_sci_data <- student_country_data %>% 
  group_by(country_name, computer) %>% 
  dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE), 
                   read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE), 
                   sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>% 
  na.omit() 


computer_plot <- comp_math_read_sci_data %>%
  ggplot(aes(x=computer, 
             y= math_avg, 
             group = country_name)) +
    geom_point(color = "black",
               size=0.36) +
    geom_line(size = .27, 
              alpha = .45) +
    theme(legend.position = "none") +
    labs(x = "Possession of Computer",
         y = "Average Mathematics Score")


internet_plot <- int_math_read_sci_data %>%
  ggplot(aes(x=internet, 
             y= math_avg, 
             group = country_name )) +
    geom_point(color = "black",
               size=0.36) +
    geom_line(size = .27, 
              alpha = .45) +
    theme(legend.position = "none") +
    labs(x = "Access to Internet",
         y = "Average Mathematics Score")


## ----compint-plot, fig.cap ="Computers and the Internet are two of the most important inventions in the history of technology. In this figure, we observe the impact of owning a computer and having access to the internet on 15-year-old students all over the world. A remarkable finding from the plot is that all nations have higher scores in student performance when they own a computer and have access to the internet.",  fig.pos = "H", out.width="100%", layout="l-body"----
computer_plot + internet_plot


## -----------------------------------------------------------------------------
student_all <- load_student("all")


#Australia data
student_country_aus <- left_join(student_all,
                                  countrycode,
                                  by = "country") %>% 
  dplyr::filter(country_name == "Australia") %>%
  group_by(year) %>%
  ungroup() %>% 
  dplyr::select(year, country_name, math, read, science, stu_wgt) %>% 
  na.omit() %>% 
  ungroup()

#nz data
student_country_nz <- left_join(student_all,
                                  countrycode,
                                  by = "country") %>% 
  dplyr::filter(country_name == "New Zealand") %>%
  group_by(year) %>%
  ungroup() %>% 
  dplyr::select(year, country_name, math, read, science, stu_wgt) %>% 
  na.omit() %>% 
  ungroup()

#qatar data
student_country_qat <- left_join(student_all,
                                  countrycode,
                                  by = "country") %>% 
  dplyr::filter(country_name == "Qatar") %>%
  group_by(year) %>%
  ungroup() %>% 
  dplyr::select(year, country_name, math, read, science, stu_wgt) %>% 
  na.omit() %>% 
  ungroup()


#indonesia data
student_country_ind <- left_join(student_all,
                                  countrycode,
                                  by = "country") %>% 
  dplyr::filter(country_name == "Indonesia") %>%
  group_by(year) %>%
  ungroup() %>% 
  dplyr::select(year, country_name, math, read, science, stu_wgt) %>% 
  na.omit() %>% 
  ungroup()



## -----------------------------------------------------------------------------
# Aus bootstrap
aus_bootstrap <- map_dfr(1:100, ~{
student_country_aus %>%
sample_n(size = n(), replace = TRUE) %>%
group_by(country_name, year) %>%
dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
                   read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
                   sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>% 
ungroup() %>%
mutate(boot_id = .x)
})


aus_bootsrap_conf_intervlas <- aus_bootstrap %>%
group_by(country_name, year) %>% 
summarise(
lower_math_avg = sort(math_avg)[5],
upper_math_avg = sort(math_avg)[95], 
lower_read_avg = sort(read_avg)[5],
upper_read_avg = sort(read_avg)[95],
lower_sci_avg = sort(sci_avg)[5],
upper_sci_avg = sort(sci_avg)[95])

aus_bs_cf <- left_join(aus_bootstrap,
                      aus_bootsrap_conf_intervlas,
                      by = c("year", "country_name"))

math_aus_plot <- ggplot(
  data = aus_bs_cf, 
  aes(x= year, 
      y = math_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_math_avg,
ymax = upper_math_avg)) +
labs(title = "Australia Maths Scores", 
     x = "Year", 
     y = "Maths Average Score") +
  theme_bw()

read_aus_plot <- ggplot(
  data = aus_bs_cf, 
  aes(x= year, 
      y = read_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_read_avg,
ymax = upper_read_avg)) +
labs(title = "Australia Reading Scores", 
     x = "Year", 
     y = "Reading Average Score") +
  theme_bw()

sci_aus_plot <- ggplot(
  data = aus_bs_cf, 
  aes(x= year, 
      y = sci_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_sci_avg,
ymax = upper_sci_avg)) +
labs(title = "Australia Science Scores", 
     x = "Year", 
     y = "Science Average Score") +
  theme_bw()


## -----------------------------------------------------------------------------
#nz boostrap
nz_bootstrap <- map_dfr(1:100, ~{
student_country_nz %>%
sample_n(size = n(), replace = TRUE) %>%
group_by(country_name, year) %>%
dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
                   read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
                   sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>% 
ungroup() %>%
mutate(boot_id = .x)
})


nz_bootsrap_conf_intervlas <- nz_bootstrap %>%
group_by(country_name, year) %>% 
summarise(
lower_math_avg = sort(math_avg)[5],
upper_math_avg = sort(math_avg)[95], 
lower_read_avg = sort(read_avg)[5],
upper_read_avg = sort(read_avg)[95],
lower_sci_avg = sort(sci_avg)[5],
upper_sci_avg = sort(sci_avg)[95])

nz_bs_cf <- left_join(nz_bootstrap,
                      nz_bootsrap_conf_intervlas,
                      by = c("year", "country_name"))

math_nz_plot <- ggplot(
  data = nz_bs_cf, 
  aes(x= year, 
      y = math_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_math_avg,
ymax = upper_math_avg)) +
labs(title = "New Zealand Maths Scores", 
     x = "Year", 
     y = "Maths Average Score") +
  theme_bw()

read_nz_plot <- ggplot(
  data = nz_bs_cf, 
  aes(x= year, 
      y = read_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_read_avg,
ymax = upper_read_avg)) +
labs(title = "New Zealand Reading Scores", 
     x = "Year", 
     y = "Reading Average Score") +
  theme_bw()

sci_nz_plot <- ggplot(
  data = nz_bs_cf, 
  aes(x= year, 
      y = sci_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_sci_avg,
ymax = upper_sci_avg)) +
labs(title = "New Zealand Science Scores", 
     x = "Year", 
     y = "Science Average Score") +
  theme_bw()


## -----------------------------------------------------------------------------
#qat boostrap
qat_bootstrap <- map_dfr(1:100, ~{
student_country_qat %>%
sample_n(size = n(), replace = TRUE) %>%
group_by(country_name, year) %>%
dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
                   read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
                   sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>% 
ungroup() %>%
mutate(boot_id = .x)
})


qat_bootsrap_conf_intervlas <- qat_bootstrap %>%
group_by(country_name, year) %>% 
summarise(
lower_math_avg = sort(math_avg)[5],
upper_math_avg = sort(math_avg)[95], 
lower_read_avg = sort(read_avg)[5],
upper_read_avg = sort(read_avg)[95],
lower_sci_avg = sort(sci_avg)[5],
upper_sci_avg = sort(sci_avg)[95])

qat_bs_cf <- left_join(qat_bootstrap,
                      qat_bootsrap_conf_intervlas,
                      by = c("year", "country_name"))

math_qat_plot <- ggplot(
  data = qat_bs_cf, 
  aes(x= year, 
      y = math_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_math_avg,
ymax = upper_math_avg)) +
labs(title = "Qatar Maths Scores", 
     x = "Year", 
     y = "Maths Average Score") +
  theme_bw()

read_qat_plot <- ggplot(
  data = qat_bs_cf, 
  aes(x= year, 
      y = read_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_read_avg,
ymax = upper_read_avg)) +
labs(title = "Qatar Reading Scores", 
     x = "Year", 
     y = "Reading Average Score") +
  theme_bw()

sci_qat_plot <- ggplot(
  data = qat_bs_cf, 
  aes(x= year, 
      y = sci_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_sci_avg,
ymax = upper_sci_avg)) +
labs(title = "Qatar Science Scores", 
     x = "Year", 
     y = "Science Average Score") +
  theme_bw()


## -----------------------------------------------------------------------------
#ind boostrap
ind_bootstrap <- map_dfr(1:100, ~{
student_country_ind %>%
sample_n(size = n(), replace = TRUE) %>%
group_by(country_name, year) %>%
dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
                   read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
                   sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>% 
ungroup() %>%
mutate(boot_id = .x)
})


ind_bootsrap_conf_intervlas <- ind_bootstrap %>%
group_by(country_name, year) %>% 
summarise(
lower_math_avg = sort(math_avg)[5],
upper_math_avg = sort(math_avg)[95], 
lower_read_avg = sort(read_avg)[5],
upper_read_avg = sort(read_avg)[95],
lower_sci_avg = sort(sci_avg)[5],
upper_sci_avg = sort(sci_avg)[95])

ind_bs_cf <- left_join(ind_bootstrap,
                      ind_bootsrap_conf_intervlas,
                      by = c("year", "country_name"))

math_ind_plot <- ggplot(
  data = ind_bs_cf, 
  aes(x= year, 
      y = math_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_math_avg,
ymax = upper_math_avg)) +
labs(title = "Indonesia Maths Scores", 
     x = "Year", 
     y = "Maths Average Score") +
  theme_bw()

read_ind_plot <- ggplot(
  data = ind_bs_cf, 
  aes(x= year, 
      y = read_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_read_avg,
ymax = upper_read_avg)) +
labs(title = "Indonesia Reading Scores", 
     x = "Year", 
     y = "Reading Average Score") +
  theme_bw()

sci_ind_plot <- ggplot(
  data = ind_bs_cf, 
  aes(x= year, 
      y = sci_avg)) +
  geom_point(alpha = 0.1) +
geom_errorbar(aes(x= year,
ymin = lower_sci_avg,
ymax = upper_sci_avg)) +
labs(title = "Indonesia Science Scores", 
     x = "Year", 
     y = "Science Average Score") +
  theme_bw()


## ----bs-plot, fig.cap ="Bootstrap", fig.pos = "H", fig.width = 20, fig.height=18, out.width="100%"----
math_aus_plot + read_aus_plot + sci_aus_plot + math_nz_plot + read_nz_plot + sci_nz_plot + math_qat_plot + read_qat_plot + sci_qat_plot + math_ind_plot + read_ind_plot + sci_ind_plot + plot_layout(ncol = 3)


## ----anim-plot, eval = knitr::is_html_output(), fig.cap ="Bootstrap Animation", fig.pos = "H", out.width="100%", layout="l-body-outset"----
#> student_country_anim <- left_join(student_all,
#>                                   countrycode,
#>                                   by = "country") %>%
#>   dplyr::filter(country_name %in% c("Australia",
#>                                     "Finland",
#>                                     "United States",
#>                                     "Peru",
#>                                     "Qatar",
#>                                     "Morocco",
#>                                     "Indonesia",
#>                                     "Brazil",
#>                                     "Thailand",
#>                                     "Singapore")) %>%
#>   group_by(year) %>%
#>   ungroup() %>%
#>   dplyr::select(year, country_name, math, read, science, stu_wgt) %>%
#>   na.omit()
#> 
#> student_country_anim_avg <- student_country_anim %>%
#> group_by(country_name, year) %>%
#> dplyr::summarise(math_avg = weighted.mean(math, w = stu_wgt, na.rm = TRUE),
#>                    read_avg = weighted.mean(read, w = stu_wgt, na.rm = TRUE),
#>                    sci_avg  =  weighted.mean(science, w = stu_wgt, na.rm = TRUE)) %>%
#> ungroup() %>%
#> rename(`Country Name` = country_name)
#> 
#> student_country_anim_avg$year <- as.numeric(student_country_anim_avg$year)
#> 
#> #animate
#> ggplot(student_country_anim_avg,
#>        aes(math_avg, sci_avg,
#>            color = `Country Name`)) +
#>   geom_point(size = 6.3, alpha = 0.54) +
#>   scale_size(range = c(2, 12)) +
#>   theme_bw() +
#>   transition_time(year) +
#>   ease_aes('linear') +
#>   labs(title = "Animation",
#>        x = "Average Maths Scores",
#>        y = "Average Science Scores")

